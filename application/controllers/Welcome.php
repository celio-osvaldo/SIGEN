<?php
defined('BASEPATH') OR exit('No direct script access allowed');

class Welcome extends CI_Controller {

	public function __Construct(){
		parent :: __construct();
		$this->load->model('Login_model');#invoke the model to use in this controller
	}

	public function Index()#the main view of system shows the login
	{
		$data['error'] = $this->session->flashdata('error');#if the users doesn't have access or incorrectly enters their credentials, an error will be displayed in the view.
		$data['title']='SiGeN';#the title of the tab that you are.
		$this->load->view('Log/in', $data);#the view of login
	}

	public function SetSession() {//function that send data of user to server
    date_default_timezone_set('America/Mexico_City');
      if ($this->input->post()) {
         $user = $this->input->post('user');//the name of input in the view for user
         $pass = $this->input->post('pass');//the name of input in the view for password
         $users = $this->Login_model->UserLogin($user, $pass);//invoke the funtion into the model
          
         if(password_verify($pass, $users->usuario_pass)){#if the query is realized
            $usuario_data = array(#its created an array with the fields to validated for login
               'id_usuario' => $users->id_usuario,#the field of table must be same in the parameter
               //'empresa_nom' => $users->empresa_nom,#the field of table must be same in the parameter
              'usuario_alias' => $users->usuario_alias,
               'usuario_nom' => $users->usuario_nom,#the field of table must be same in the parameter
               'usuario_tipo' => $users->usuario_tipo,
               'GetSession' => true);//If last data are true the next function will execute
            $this->session->set_userdata($usuario_data);//Varable session content the array for validate form
            redirect('Welcome/GetSession');//once time that all data is validates the function redirect to GetSession for know wich view should show.
         } else {

         	$this->session->set_flashdata('error', 'Usuario y/o contraseña incorrectos.');//if not exist the user, just show an error in the view
            redirect('/');//redirect to index for the user can correctly log
         } 
    } 
    // else{
    //         $this->Index();#Any case ever show Index view;
    //      }
   }

   public function GetSession() {//function for redirect to users at respective interface
      switch($this->session->userdata('usuario_tipo')){//according to company that the user will redirect to interface that it belong
        case '1':
               redirect('Welcome/Companies');#rdirect to main view of super user
         break;
        case '2':
               redirect('Welcome/Companies');#rdirect to main view of super user
         break;
         default:
         $this->session->set_flashdata('error', 'Usuario y/o contraseña incorrectos.');//if not exist the user, just show an error in the view
         redirect('/');//If doesn´t exist user will redirect to Index view
      }
   }

	public function Dasa(){
		redirect('/Dasa/Index', 'refresh');
	}

	public function Iluminacion(){
		redirect('/Iluminacion/Index', 'refresh');
	}

	public function Salinas(){
		redirect('/Salinas/Index', 'refresh');
	}
  public function Quinta(){
    redirect('/Quinta/Index', 'refresh');
  }

   public function LogSuperUser(){
       redirect('/SuperUser/Index', 'refresh');
   }

   public function Companies(){
      if ($this->session->userdata('usuario_alias')) {#verified if a user is logged and don´t lose the session
          $data['title']='SiGeN';#the title of the tab that you are.
          $data['alias'] = $this->session->userdata('usuario_alias');#Return the name alias of user for showing
          $data['id_user'] = $this->session->userdata('id_usuario');
          $data['type'] = $this->session->userdata('usuario_tipo');#it will know who type of user 


          if ($this->session->userdata('usuario_tipo') == "1") { 
            $this->load->view('plantillas/header', $data);
            $this->load->view('SuperUser/companies');
            $this->load->view('plantillas/footer');
          }else{
            //$data['type'] = '2';
         $this->load->view('plantillas/header', $data);
         $this->load->view('SuperUser/companies');
         $this->load->view('plantillas/footer');
         }
      }
      else{#if not there a session started or if it is destroy ever redirect to login
        $this->session->set_flashdata('error', 'No ha iniciado Sesión');//if not exist the user, just show an error in the view
         redirect('/');
      }
   }

#end controller
}
